<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Display Controller</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #1a1a2e;
    color: #eee;
    min-height: 100vh;
  }
  .header {
    background: #16213e;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #0f3460;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .status { display: flex; align-items: center; gap: 8px; font-size: 14px; }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #e74c3c; transition: background 0.3s;
  }
  .status-dot.online { background: #2ecc71; }
  .notification {
    display: none; position: fixed; top: 60px; right: 24px;
    background: #2ecc71; color: #fff; padding: 12px 20px;
    border-radius: 8px; font-size: 14px; font-weight: 500;
    z-index: 100; animation: slideIn 0.3s ease;
  }
  .notification.offline { background: #e74c3c; }
  @keyframes slideIn {
    from { transform: translateX(100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .container {
    display: flex; gap: 24px; padding: 24px; max-width: 1400px;
    margin: 0 auto; flex-wrap: wrap; justify-content: center;
  }
  .preview-section { display: flex; flex-direction: column; align-items: center; gap: 16px; }
  .preview-label { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
  .display-frame {
    width: 280px; height: 280px; border-radius: 50%; background: #000;
    border: 4px solid #333; display: flex; align-items: center;
    justify-content: center; overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5);
  }
  .display-content {
    width: 240px; height: 240px; border-radius: 50%; background: #000;
    overflow: hidden; display: flex; flex-direction: column;
  }
  .display-text {
    padding: 28px; font-family: 'Courier New', monospace; font-size: 13px;
    color: #fff; line-height: 1.4; word-wrap: break-word;
    overflow: hidden; flex: 1; white-space: pre-wrap;
  }
  .display-dots { display: flex; justify-content: center; gap: 8px; padding-bottom: 16px; }
  .display-dots .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
  .display-dots .dot.active { background: #fff; }
  .preview-nav { display: flex; gap: 12px; }
  .preview-nav button {
    background: #16213e; color: #eee; border: 1px solid #0f3460;
    padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;
  }
  .preview-nav button:hover { background: #0f3460; }
  .page-info { font-size: 14px; color: #888; min-width: 60px; text-align: center; line-height: 36px; }

  .editor-section { flex: 1; min-width: 300px; max-width: 450px; }
  .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .editor-header h2 { font-size: 16px; }
  .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
  .btn-secondary { background: #16213e; color: #eee; border: 1px solid #0f3460; }
  .btn-secondary:hover { background: #0f3460; }
  .btn-send { background: #2ecc71; color: #fff; padding: 12px 32px; font-size: 16px; width: 100%; margin-top: 16px; }
  .btn-send:hover { background: #27ae60; }

  .screens-list { display: flex; flex-direction: column; gap: 12px; }
  .screen-card { background: #16213e; border: 1px solid #0f3460; border-radius: 8px; padding: 12px; }
  .screen-card.active { border-color: #e94560; }
  .screen-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .screen-card-header span { font-size: 13px; color: #888; font-weight: 600; }
  .screen-card textarea {
    width: 100%; min-height: 80px; background: #0a0a1a; color: #eee;
    border: 1px solid #333; border-radius: 4px; padding: 10px;
    font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; line-height: 1.4;
  }
  .screen-card textarea:focus { outline: none; border-color: #e94560; }
  .btn-remove { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 18px; padding: 2px 6px; border-radius: 4px; }
  .btn-remove:hover { background: rgba(231,76,60,0.2); }

  /* Settings */
  .settings-panel {
    background: #16213e; border: 1px solid #0f3460; border-radius: 8px;
    padding: 14px; margin-top: 12px;
  }
  .settings-panel h3 { font-size: 13px; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
  .setting-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .setting-row:last-child { margin-bottom: 0; }
  .setting-label { font-size: 13px; min-width: 80px; color: #aaa; }
  .setting-row input[type="range"] {
    flex: 1; accent-color: #e94560; height: 6px; cursor: pointer;
  }
  .setting-value { font-size: 13px; min-width: 35px; text-align: right; color: #e94560; }
  .text-size-btns { display: flex; gap: 6px; }
  .text-size-btns button {
    background: #0f3460; color: #eee; border: 1px solid #1a3a6e;
    width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
    font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center;
  }
  .text-size-btns button:hover { background: #1a4a80; }
  .text-size-display { font-size: 14px; min-width: 30px; text-align: center; color: #e94560; }

  /* History */
  .history-section { min-width: 280px; max-width: 350px; }
  .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .history-header h2 { font-size: 16px; }
  .history-count { font-size: 12px; color: #888; background: #0f3460; padding: 4px 10px; border-radius: 12px; }
  .history-list { display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto; }
  .history-item {
    background: #16213e; border: 1px solid #0f3460; border-radius: 8px;
    padding: 10px 12px; cursor: pointer;
  }
  .history-item:hover { border-color: #e94560; background: #1a2744; }
  .history-item-time { font-size: 11px; color: #666; margin-bottom: 4px; }
  .history-item-text {
    font-family: 'Courier New', monospace; font-size: 12px; color: #ccc;
    white-space: pre-wrap; word-break: break-word; max-height: 60px; overflow: hidden;
  }
  .history-item-resend { font-size: 11px; color: #e94560; margin-top: 6px; opacity: 0; }
  .history-item:hover .history-item-resend { opacity: 1; }

  .gesture-log {
    margin-top: 16px; padding: 12px; background: #16213e;
    border: 1px solid #0f3460; border-radius: 8px;
    font-size: 12px; color: #888; max-height: 80px; overflow-y: auto;
  }
  .gesture-log .entry { padding: 2px 0; }
  .gesture-log .entry span { color: #e94560; }

  .toast {
    position: fixed; bottom: 24px; right: 24px; background: #2ecc71;
    color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 14px;
    opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.error { background: #e74c3c; }
  .empty-state { text-align: center; color: #555; padding: 32px 16px; font-size: 13px; }
</style>
</head>
<body>

<div class="header">
  <h1>ESP32 Display Controller</h1>
  <div class="status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Connecting...</span>
  </div>
</div>

<div class="notification" id="notification"></div>

<div class="container">
  <div class="preview-section">
    <div class="preview-label">Display Preview</div>
    <div class="display-frame">
      <div class="display-content">
        <div class="display-text" id="previewText">No screens</div>
        <div class="display-dots" id="previewDots"></div>
      </div>
    </div>
    <div class="preview-nav">
      <button onclick="previewPrev()">&larr; Prev</button>
      <div class="page-info" id="pageInfo">0 / 0</div>
      <button onclick="previewNext()">Next &rarr;</button>
    </div>
    <!-- Settings -->
    <div class="settings-panel">
      <h3>Display Settings</h3>
      <div class="setting-row">
        <span class="setting-label">Brightness</span>
        <input type="range" id="brightnessSlider" min="0" max="255" value="255" oninput="changeBrightness(this.value)">
        <span class="setting-value" id="brightnessValue">255</span>
      </div>
      <div class="setting-row">
        <span class="setting-label">Text Size</span>
        <div class="text-size-btns">
          <button onclick="changeTextSize(-1)">-</button>
          <span class="text-size-display" id="textSizeValue">1</span>
          <button onclick="changeTextSize(1)">+</button>
        </div>
      </div>
    </div>
    <div class="gesture-log" id="gestureLog">
      <div class="entry" style="color:#555;">Touch gestures will appear here</div>
    </div>
  </div>

  <div class="editor-section">
    <div class="editor-header">
      <h2>Screens</h2>
      <button class="btn btn-secondary" onclick="addScreen()">+ Add Screen</button>
    </div>
    <div class="screens-list" id="screensList"></div>
    <button class="btn btn-send" id="sendBtn" onclick="sendScreens()">Send to Display</button>
  </div>

  <div class="history-section">
    <div class="history-header">
      <h2>Sent Today</h2>
      <span class="history-count" id="historyCount">0</span>
    </div>
    <div class="history-list" id="historyList">
      <div class="empty-state">No messages sent today</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var screens = [{ id: 1, text: '' }];
var previewIndex = 0;
var nextId = 2;
var ws = null;
var deviceOnline = false;
var history = [];
var prevDeviceOnline = null;
var currentBrightness = 255;
var currentTextSize = 1;

function connectWS() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/?role=browser');

  ws.onopen = function() {
    updateStatus('Server connected', false);
  };

  ws.onmessage = function(e) {
    var msg = JSON.parse(e.data);
    switch (msg.type) {
      case 'init':
        if (msg.screens && msg.screens.length > 0) {
          screens = msg.screens;
          nextId = Math.max.apply(null, screens.map(function(s) { return s.id; })) + 1;
          forceRenderScreens();
          updatePreview();
        }
        deviceOnline = msg.deviceOnline;
        updateStatus(deviceOnline ? 'Device online' : 'Device offline', deviceOnline);
        if (msg.history) { history = msg.history; renderHistory(); }
        if (msg.settings) {
          currentBrightness = msg.settings.brightness || 255;
          currentTextSize = msg.settings.textSize || 1;
          document.getElementById('brightnessSlider').value = currentBrightness;
          document.getElementById('brightnessValue').textContent = currentBrightness;
          document.getElementById('textSizeValue').textContent = currentTextSize;
        }
        prevDeviceOnline = deviceOnline;
        break;

      case 'device_status':
        var wasOnline = deviceOnline;
        deviceOnline = msg.online;
        var statusText = deviceOnline ? 'Device online' : 'Device offline';
        if (deviceOnline && msg.screen !== undefined) {
          statusText = 'Device online (screen ' + ((msg.screen||0)+1) + '/' + (msg.total||'?') + ')';
        }
        updateStatus(statusText, deviceOnline);
        if (prevDeviceOnline !== null && wasOnline !== deviceOnline) {
          showNotification(
            deviceOnline ? 'ESP32 is now ONLINE' : 'ESP32 went OFFLINE',
            !deviceOnline
          );
        }
        prevDeviceOnline = deviceOnline;
        break;

      case 'screens_sent':
        showToast('Sent ' + msg.count + ' screen(s) to device');
        if (msg.history) { history = msg.history; renderHistory(); }
        break;

      case 'history':
        history = msg.data || [];
        renderHistory();
        break;

      case 'touch':
        logGesture(msg.gesture);
        break;
    }
  };

  ws.onclose = function() {
    updateStatus('Disconnected', false);
    setTimeout(connectWS, 3000);
  };

  ws.onerror = function() { ws.close(); };
}

function updateStatus(text, online) {
  document.getElementById('statusDot').className = 'status-dot' + (online ? ' online' : '');
  document.getElementById('statusText').textContent = text;
}

function showNotification(text, isOffline) {
  var el = document.getElementById('notification');
  el.textContent = text;
  el.className = 'notification' + (isOffline ? ' offline' : '');
  el.style.display = 'block';
  setTimeout(function() { el.style.display = 'none'; }, 4000);
}

// Settings
function changeBrightness(val) {
  currentBrightness = parseInt(val);
  document.getElementById('brightnessValue').textContent = currentBrightness;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'settings', brightness: currentBrightness }));
  }
}

function changeTextSize(delta) {
  currentTextSize = Math.max(1, Math.min(4, currentTextSize + delta));
  document.getElementById('textSizeValue').textContent = currentTextSize;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'settings', textSize: currentTextSize }));
  }
}

// Screens
function renderScreens() {
  var list = document.getElementById('screensList');
  var existingCards = list.querySelectorAll('.screen-card');
  if (existingCards.length === screens.length) {
    for (var i = 0; i < existingCards.length; i++) {
      existingCards[i].className = 'screen-card' + (i === previewIndex ? ' active' : '');
    }
    return;
  }
  forceRenderScreens();
}

function forceRenderScreens() {
  var list = document.getElementById('screensList');
  list.innerHTML = '';
  for (var i = 0; i < screens.length; i++) {
    var card = document.createElement('div');
    card.className = 'screen-card' + (i === previewIndex ? ' active' : '');
    var removeBtn = screens.length > 1
      ? '<button class="btn-remove" onclick="removeScreen(' + i + ')">&times;</button>'
      : '';
    card.innerHTML = '<div class="screen-card-header">'
      + '<span>Screen ' + (i + 1) + '</span>'
      + removeBtn
      + '</div>'
      + '<textarea placeholder="Enter text for this screen..."'
      + ' oninput="updateScreenText(' + i + ', this.value)"'
      + ' onfocus="selectScreen(' + i + ')"'
      + '>' + screens[i].text + '</textarea>';
    list.appendChild(card);
  }
}

function selectScreen(index) {
  previewIndex = index;
  var cards = document.querySelectorAll('.screen-card');
  for (var i = 0; i < cards.length; i++) {
    cards[i].className = 'screen-card' + (i === previewIndex ? ' active' : '');
  }
  updatePreview();
}

function addScreen() {
  screens.push({ id: nextId++, text: '' });
  previewIndex = screens.length - 1;
  forceRenderScreens();
  updatePreview();
  var textareas = document.querySelectorAll('.screen-card textarea');
  if (textareas.length > 0) textareas[textareas.length - 1].focus();
}

function removeScreen(index) {
  screens.splice(index, 1);
  if (previewIndex >= screens.length) previewIndex = screens.length - 1;
  forceRenderScreens();
  updatePreview();
}

function updateScreenText(index, text) {
  screens[index].text = text;
  if (index === previewIndex) updatePreview();
}

// Preview
function updatePreview() {
  var textEl = document.getElementById('previewText');
  var dotsEl = document.getElementById('previewDots');
  var infoEl = document.getElementById('pageInfo');
  if (screens.length === 0) {
    textEl.textContent = 'No screens';
    dotsEl.innerHTML = '';
    infoEl.textContent = '0 / 0';
    return;
  }
  textEl.textContent = screens[previewIndex].text || '(empty)';
  infoEl.textContent = (previewIndex + 1) + ' / ' + screens.length;
  dotsEl.innerHTML = '';
  if (screens.length > 1) {
    for (var i = 0; i < screens.length; i++) {
      var dot = document.createElement('div');
      dot.className = 'dot' + (i === previewIndex ? ' active' : '');
      dotsEl.appendChild(dot);
    }
  }
}

function previewPrev() {
  if (previewIndex > 0) { previewIndex--; renderScreens(); updatePreview(); }
}
function previewNext() {
  if (previewIndex < screens.length - 1) { previewIndex++; renderScreens(); updatePreview(); }
}

function sendScreens() {
  if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('Not connected to server', true); return; }
  ws.send(JSON.stringify({ type: 'screens', data: screens }));
}

// History
function renderHistory() {
  var list = document.getElementById('historyList');
  var countEl = document.getElementById('historyCount');
  countEl.textContent = history.length;
  if (history.length === 0) {
    list.innerHTML = '<div class="empty-state">No messages sent today</div>';
    return;
  }
  list.innerHTML = '';
  for (var i = history.length - 1; i >= 0; i--) {
    var item = history[i];
    if (!item) continue; // Defensively skip if item is null/undefined

    var el = document.createElement('div');
    el.className = 'history-item';
    
    var time = item.sentAt ? new Date(item.sentAt).toLocaleTimeString() : 'No timestamp';
    var text = item.text || ''; // Default to empty string if text is missing
    var preview = text.length > 100 ? text.substring(0, 100) + '...' : text;
    
    el.innerHTML = '<div class="history-item-time">' + time + '</div>'
      + '<div class="history-item-text">' + escapeHtml(preview) + '</div>'
      + '<div class="history-item-resend">Click to resend</div>';
    
    el.setAttribute('data-text', text);
    el.onclick = function() { resendFromHistory(this.getAttribute('data-text')); };
    list.appendChild(el);
  }
}

function resendFromHistory(text) {
  if (!ws || ws.readyState !== WebSocket.OPEN) { showToast('Not connected', true); return; }
  ws.send(JSON.stringify({ type: 'resend', text: text }));
  showToast('Message resent');
}

function escapeHtml(str) {
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showToast(msg, isError) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(function() { toast.className = 'toast'; }, 3000);
}

function logGesture(gesture) {
  var log = document.getElementById('gestureLog');
  var names = { swipe_left: 'Swipe Left', swipe_right: 'Swipe Right', double_tap: 'Double Tap' };
  var time = new Date().toLocaleTimeString();
  var entry = document.createElement('div');
  entry.className = 'entry';
  entry.innerHTML = '<span>' + (names[gesture] || gesture) + '</span> at ' + time;
  log.prepend(entry);
  while (log.children.length > 20) log.removeChild(log.lastChild);
}

document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') sendScreens();
});

forceRenderScreens();
updatePreview();
connectWS();
</script>
</body>
</html>
